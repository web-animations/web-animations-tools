<!--
Copyright 2014 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations
under the License.
-->

<!--
/**
 * @module Web Animations Tools
 */
/**
 * `wat-github` can be used to save and load GitHub gists, either anonymously or
 * to an existing GitHub account.
 *
 * Example:
 *
 *     <wat-github></wat-github>
 *
 * @class wat-github
 */
/**
 * Fired when a GitHub gist is successfully created. Response object contains
 * the ID of the gist.
 *
 * @event files-saved
 */
/**
 * Fired when a GitHub gist is successfully read. Response object properties are
 * the files in the gist, named using whatever filenames were specified when the
 * gist was saved.
 *
 * @event files-loaded
 */
 /**
 * Fired when the GitHub personal access token changes.
 *
 * @event token-changed
 */
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../internal/wat-button/wat-button.html">

<polymer-element name="wat-github" attributes="message">
  <template>
    <style>
      .grey-paper {
        box-shadow: 0px 2px 4px rgba(0,0,0,0.2);
        border: 1px solid #ccc;
        border-radius: 3px;
        margin: 5px;
        padding: 5px;
        background-color: rgba(242,242,242,1); 
      }

      #form {
        vertical-align: middle; 
        margin-top: 12px;
      }

      #form label {
        color: rgba(96,96,96,1);
      }

      #signIn-screen {
        display: {{signingIn ? '' : 'none'}};
        position: absolute; 
        left: calc(50vw - 125px); 
        top: calc(40vh - 60px); 
        width: 250px; 
        height: 120px; 
        z-index: 6;
        text-align: center;
        vertical-align: middle;
      }

      wat-button {
        display: inline-flex;
        margin: 10px 2.5px;
        width: 115px;
        height: 32px;
      }

      wat-button ^^ button {
        padding: 5px;
      }

      #github-token{
        display: inline-block;
        width: 235px;
        margin: 8px 5px 5px 5px;
        padding: 0px 1px;
        vertical-align: middle;
        border: 1px solid silver;
        border-radius: 2px;
        height: 20px;
      }

      #github-token:focus {
        border: 1px solid rgba(66,133,244,1);
        outline: none;
      }
    </style>

    <div id="signIn-screen" class="grey-paper">
      <div id="form">
        <label for="github-token">GitHub Token:</label>
        <input id="github-token" type="text" on-keyup="{{checkKeyCode}}">
        <div>
          <wat-button on-click="{{confirm}}" title="Confirm">Confirm</wat-button>
          <wat-button on-click="{{cancel}}" title="Cancel">Cancel</wat-button>
        </div>
      </div>
    </div>
  </template>

  <script src="../../github-js/lib/underscore-min.js"></script>
  <script src="../../github-js/lib/base64.js"></script>
  <script src="../../github-js/github.js"></script>
  
  <script>
    Polymer('wat-github', {
      /**
       * The personal access token to use when creating a new `Github` instance.
       * If left blank, then an anonymous `Github` instance is created. The
       * token can be set by the user in a form that is displayed when the
       * `signIn()` function is called. The token is stored in local storage.
       *
       * @attribute token
       * @type string
       * @default ''
       */
      token: '',
      /**
       * A response or error message relating to the most recently sent GitHub
       * request. This message is not displayed in `wat-github` but is a
       * published property, so it may be displayed in the containing element.
       *
       * @attribute message
       * @type string
       * @default ''
       */
      message: '',
      /**
       * Indicates whether or not the user is signed in. `signedIn` is false if
       * `token` is not set, else it is true. Note that attempting to use an
       * invalid token will result in the token being set to an empty string.
       *
       * @attribute signedIn
       * @type boolean
       * @default false
       */
      signedIn: false,
      signingIn: false,

      ready: function() {
        this.token = window.localStorage['wat_token'] || '';
        this.github = new Github({token: this.token});
      },

      tokenChanged: function() {
        if (this.token) {
          this.signedIn = true;
          window.localStorage['wat_token'] = this.token;
        } else {
          this.signedIn = false;
          window.localStorage.clear();
        }
      },

      /**
       * Sets the `message` to a given string for 3 seconds, then clears it.
       *
       * @method toast
       * @param {string} message
       */
      toast: function(message) {
        this.message = message;
        if (this.message) {
          this.clearMessage(3000);
        }
      },

      /**
       * Sets the `message` to an empty string after a specified number of
       * milliseconds.
       *
       * @method clearMessage
       * @param {number} [delay] The number of milliseconds to wait before clearing the message.
       */
      clearMessage: function(delay) {
        if (this.messageTimeout) {
          clearTimeout(this.messageTimeout);
        }
        if (delay === undefined) {
          delay = 3000;
        }
        this.messageTimeout = setTimeout(function() {
          this.message = '';
        }.bind(this), delay);
      },

      /**
       * Saves a gist to GitHub containing the files specified. Fires the
       * `files-saved` event on success, and sends the gist ID back in the event
       * object. Also calls `toast()` with a success or failure message.
       *
       * @method save
       * @param {string} description A description of the gist.
       * @param {boolean} publicGist If true, gist is public. Else it is secret.
       * @param {object} files An object containing file content and file names.
       *
       * Example:
       *     var description = "WAT?!";
       *     var publicGist = true;
       *     var files = {
       *       'filename1': {content: 'content1'},
       *       'filename2': {content: 'content2'},
       *       ...
       *     };
       *     save(description, publicGist, files);
       */
      save: function(description, publicGist, files) {
        if (!this.github) {
          return;
        }

        var gist = this.github.getGist();
        gist.create({
          'description': description,
          'public': publicGist,
          'files': files,
          }, function(error, response) {
            if (!error) {
              this.fire('files-saved', response.id);
              this.toast('Saved files to ' + response.html_url);
            } else {
              if (error.error == 401) { // unauthorized
                this.token = '';
                this.toast('Please sign in using a valid GitHub token.');
              } else if (error.error == 403) { // forbidden
                this.toast('Sorry, too much anonymous GitHub activity! ' +
                    'Please either sign in or try again later.');
              } else {
                console.error(error);
              }
            }
          }.bind(this));
      },

      /**
       * Updates a previously saved GitHub gist using the specified ID and then
       * calls `toast()` with a success or failure message.
       *
       * @method update
       * @param {string} id The ID of the gist.
       * @param {string} description A description of the gist.
       * @param {boolean} publicGist If true, gist is public. Else it is secret.
       * @param {object} files An object containing file content and file names.
       *
       * Example:
       *     var id = window.location.hash.substring(1);
       *     var description = "WAT?!";
       *     var publicGist = true;
       *     var files = {
       *       'filename1': {content: 'content1'},
       *       'filename2': {content: 'content2'},
       *       ...
       *     };
       *     update(id, description, publicGist, files);
       */
      update: function(id, description, publicGist, files) {
        if (!this.github) {
          return;
        }

        var gist = this.github.getGist(id);
        gist.update({
          'description': description,
          'files': files,
          }, function(error, response) {
            if (!error) {
              this.toast('Saved files to ' + response.html_url);
            } else {
              if (error.error == 401) { // unauthorized
                this.token = '';
                this.toast('Please sign in using a valid GitHub token.');
              } else if (error.error == 403) { // forbidden
                this.toast('Sorry, too much anonymous GitHub activity! ' +
                    'Please either sign in or try again later.');
              } else if (error.error == 404) { // not found
                this.toast('The animation was not updated because it could ' +
                    'not be found on GitHub.');
              } else {
                console.error(error);
              }
            }
          }.bind(this));
      },

      /**
       * Loads a gist from GitHub using the specified ID. Fires the
       * `files-loaded` event on success, and sends the gist files back in the
       * event object. Also calls `toast()` with a success or failure message.
       *
       * @method load
       * @param {string} id The ID of the gist.
       */
      load: function(id) {
        if (!this.github) {
          return;
        }
        
        var gist = this.github.getGist(id);
        gist.read(function(error, response) {
          if (!error) {
            this.fire('files-loaded', response.files);
            this.toast('Loaded files from ' + response.html_url);
          } else {
            if (error.error == 401) { // unauthorized
              this.token = '';
              this.toast('Please sign in using a valid GitHub token.');
            } else if (error.error == 403) { // forbidden
              this.toast('Sorry, too much anonymous GitHub activity! ' +
                  'Please either sign in or try again later.');
            } else if (error.error == 404) { // not found
              this.toast('The animation was not loaded because it could not ' +
                  'be found on GitHub.');
            } else {
              console.error(error);
            }
          }
        }.bind(this));
      },

      /**
       * Displays a sign-in screen so that the user can enter their GitHub
       * personal access token.
       *
       * @method signIn
       */
      signIn: function() {
        this.signingIn = true;
        setTimeout(function() {
          this.$['github-token'].focus()
        }.bind(this), 0);
      },

      /**
       * Sets the GitHub token to an empty string and then fires the
       * `token-changed` event.
       *
       * @method signOut
       */
      signOut: function() {
        this.token = '';
        this.github = new Github({token: this.token});
        this.fire('token-changed');
      },

      confirm: function() {
        this.token = this.$['github-token'].value;
        this.github = new Github({token: this.token});
        this.fire('token-changed');
        this.signingIn = false;
      },

      cancel: function() {
        this.signingIn = false;
      },

      checkKeyCode: function(e) {
        console.log(e);
        if (e.keyCode == 13) { // 'Enter'
          this.confirm();
        } else if (e.keyCode == 27) { // 'Escape'
          this.cancel();
        }
      }
    });
  </script>
</polymer-element>
